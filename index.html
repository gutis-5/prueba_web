<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Gestor de H√°bitos con Telegram WebApp</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
      background-color: #f9f9f9;
    }
    h1 {
      margin-bottom: 1rem;
    }
    .input-group {
      margin-bottom: 15px;
    }
    .input-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
    }
    .input-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid #eee;
      border-radius: 6px;
      font-size: 1rem;
    }

    /* Secci√≥n "H√°bitos registrados" */
    #habitosSeleccionadosContainer {
      background-color: #fff;
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    #habitosSeleccionadosContainer h2 {
      margin: 0 0 10px 0;
      font-size: 1.1rem;
      font-weight: 600;
    }
    #selectedHabitsList {
      font-size: 0.9rem;
      color: #666;
      min-height: 20px;
    }

    /* Acorde√≥n */
    .accordion {
      border: 1px solid #eee;
      border-radius: 8px;
      margin-bottom: 10px;
      overflow: hidden;
      background-color: #fff;
    }
    .accordion-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px;
      background-color: #fafafa;
      cursor: pointer;
    }
    .accordion-header h3 {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
    }
    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .accordion-content.open {
      padding: 15px;
      border-top: 1px solid #eee;
    }

    /* Grid de 3 columnas para los h√°bitos */
    .habit-list {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    .habit-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px;
      border: 1px solid #eee;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
      background-color: #fff;
    }
    .habit-item:hover {
      background-color: #fdfdfd;
    }
    .habit-item.selected {
      border-color: #ff9090;
      background-color: #ffecee;
    }
    .habit-label {
      display: flex;
      align-items: center;
      gap: 8px;
      pointer-events: none;
    }
    .habit-icon {
      font-size: 1.4rem;
    }
    .plus-btn {
      background-color: transparent;
      border: none;
      font-size: 1.2rem;
      color: #f06292;
      cursor: pointer;
    }

    /* Campo para h√°bito personalizado con emoji */
    .custom-habit-wrapper {
      grid-column: span 3;
      display: flex;
      gap: 8px;
      align-items: center;
      padding: 10px;
      margin-top: 10px;
      border-top: 1px dashed #ddd;
    }
    .custom-emoji-input {
      width: 60px;
      text-align: center;
      border: 1px solid #eee;
      border-radius: 6px;
      font-size: 1rem;
      padding: 8px;
    }
    .custom-habit-input {
      flex: 1;
      padding: 8px;
      border: 1px solid #eee;
      border-radius: 6px;
      font-size: 1rem;
    }
    .custom-habit-btn {
      background-color: #f06292;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.6rem 1rem;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .custom-habit-btn:hover {
      background-color: #ec407a;
    }

    /* Secci√≥n Objetivos */
    #objetivosContainer {
      background-color: #fff;
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
      margin-bottom: 20px;
    }
    #objetivosContainer h2 {
      margin: 0 0 10px 0;
      font-size: 1.1rem;
      font-weight: 600;
    }
    #objetivosList {
      font-size: 0.9rem;
      color: #333;
    }
    .objetivo-row {
      margin-bottom: 15px;
    }
    .objetivo-row label {
      font-weight: 600;
      min-width: 120px;
      display: inline-block;
      margin-bottom: 5px;
    }
    .objetivo-content {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 5px;
    }
    .objetivo-input {
      flex: 1;
      padding: 8px;
      border: 1px solid #eee;
      border-radius: 6px;
      font-size: 0.9rem;
    }
    .remove-objetivo-btn {
      background-color: #bbb;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .remove-objetivo-btn:hover {
      background-color: #999;
    }
    .objetivo-plus-btn {
      background-color: #f06292;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-size: 0.8rem;
      margin-left: 10px;
    }
    .objetivo-plus-btn:hover {
      background-color: #ec407a;
    }

    .frequency-row {
      margin-left: 30px;
      margin-top: 5px;
    }
    .frequency-select {
      padding: 5px 8px;
      font-size: 0.9rem;
      border-radius: 6px;
      border: 1px solid #eee;
    }

    /* Ocultamos cualquier bot√≥n manual de Enviar (si existiera) */
    .send-button {
      display: none;
    }
  </style>
</head>
<body ng-app="custom-webapp-ui" ng-controller="CustomUIController">
  <h1>Gestor de H√°bitos con Telegram WebApp</h1>

  <!-- Nombre y Edad con asteriscos (*) -->
  <div class="input-group">
    <label for="nombre">Nombre *</label>
    <input type="text" id="nombre" placeholder="Ingresa tu nombre" ng-model="userInfo.name" ng-change="updateMainButton()">
  </div>
  <div class="input-group">
    <label for="edad">Edad *</label>
    <input type="number" id="edad" placeholder="Ingresa tu edad" ng-model="userInfo.age" ng-change="updateMainButton()">
  </div>

  <!-- H√°bitos Registrados con * -->
  <div id="habitosSeleccionadosContainer">
    <h2>H√°bitos registrados *</h2>
    <div id="selectedHabitsList">{{ userInfo.habitsListStr || '(vac√≠o)' }}</div>
  </div>

  <!-- ACORDEONES POR CATEGOR√çA -->
  <div class="accordion" data-category="salud">
    <div class="accordion-header">
      <h3>Salud</h3>
      <span>+</span>
    </div>
    <div class="accordion-content">
      <div class="habit-list">
        <!-- Ejemplo de items "Salud" -->
        <div class="habit-item" data-category="Salud" data-habit="Beber agua">
          <div class="habit-label">
            <span class="habit-icon">üíß</span>
            <span>Beber agua</span>
          </div>
          <button class="plus-btn">+</button>
        </div>
        <div class="habit-item" data-category="Salud" data-habit="Comer frutas">
          <div class="habit-label">
            <span class="habit-icon">üçì</span>
            <span>Comer frutas</span>
          </div>
          <button class="plus-btn">+</button>
        </div>
        <div class="habit-item" data-category="Salud" data-habit="Comer verduras">
          <div class="habit-label">
            <span class="habit-icon">ü•¶</span>
            <span>Comer verduras</span>
          </div>
          <button class="plus-btn">+</button>
        </div>

        <div class="custom-habit-wrapper">
          <input type="text" class="custom-emoji-input" placeholder="Emoji">
          <input type="text" class="custom-habit-input" placeholder="H√°bito personalizado...">
          <button class="custom-habit-btn">Agregar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Repetir acordeones para Deporte, Estilo de Vida, Tiempo, Dejar... -->
  <div class="accordion" data-category="Deporte">
    <div class="accordion-header">
      <h3>Deporte</h3>
      <span>+</span>
    </div>
    <div class="accordion-content">
      <div class="habit-list">
        <div class="habit-item" data-category="Deporte" data-habit="Caminar">
          <div class="habit-label">
            <span class="habit-icon">üö∂‚Äç‚ôÇÔ∏è</span>
            <span>Caminar</span>
          </div>
          <button class="plus-btn">+</button>
        </div>
        <div class="habit-item" data-category="Deporte" data-habit="Correr">
          <div class="habit-label">
            <span class="habit-icon">üèÉ‚Äç‚ôÇÔ∏è</span>
            <span>Correr</span>
          </div>
          <button class="plus-btn">+</button>
        </div>
        <div class="habit-item" data-category="Deporte" data-habit="Yoga">
          <div class="habit-label">
            <span class="habit-icon">üßò‚Äç‚ôÄÔ∏è</span>
            <span>Yoga</span>
          </div>
          <button class="plus-btn">+</button>
        </div>
        <div class="custom-habit-wrapper">
          <input type="text" class="custom-emoji-input" placeholder="Emoji">
          <input type="text" class="custom-habit-input" placeholder="H√°bito personalizado...">
          <button class="custom-habit-btn">Agregar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Estilo de Vida -->
  <div class="accordion" data-category="Estilo de Vida">
    <div class="accordion-header">
      <h3>Estilo de Vida</h3>
      <span>+</span>
    </div>
    <div class="accordion-content">
      <div class="habit-list">
        <div class="habit-item" data-category="Estilo de Vida" data-habit="Respiraci√≥n consciente">
          <div class="habit-label">
            <span class="habit-icon">üòÆ‚Äçüí®</span>
            <span>Respiraci√≥n consciente</span>
          </div>
          <button class="plus-btn">+</button>
        </div>
        <div class="habit-item" data-category="Estilo de Vida" data-habit="Meditaci√≥n">
          <div class="habit-label">
            <span class="habit-icon">üßò</span>
            <span>Meditaci√≥n</span>
          </div>
          <button class="plus-btn">+</button>
        </div>
        <div class="habit-item" data-category="Estilo de Vida" data-habit="Leer un libro">
          <div class="habit-label">
            <span class="habit-icon">üìö</span>
            <span>Leer un libro</span>
          </div>
          <button class="plus-btn">+</button>
        </div>
        <div class="custom-habit-wrapper">
          <input type="text" class="custom-emoji-input" placeholder="Emoji">
          <input type="text" class="custom-habit-input" placeholder="H√°bito personalizado...">
          <button class="custom-habit-btn">Agregar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tiempo -->
  <div class="accordion" data-category="Tiempo">
    <div class="accordion-header">
      <h3>Tiempo</h3>
      <span>+</span>
    </div>
    <div class="accordion-content">
      <div class="habit-list">
        <div class="habit-item" data-category="Tiempo" data-habit="Revisar el d√≠a">
          <div class="habit-label">
            <span class="habit-icon">üìù</span>
            <span>Revisar el d√≠a</span>
          </div>
          <button class="plus-btn">+</button>
        </div>
        <div class="habit-item" data-category="Tiempo" data-habit="Limpiar la mente">
          <div class="habit-label">
            <span class="habit-icon">üí°</span>
            <span>Limpiar la mente</span>
          </div>
          <button class="plus-btn">+</button>
        </div>
        <div class="habit-item" data-category="Tiempo" data-habit="Planificar ma√±ana">
          <div class="habit-label">
            <span class="habit-icon">üóìÔ∏è</span>
            <span>Planificar ma√±ana</span>
          </div>
          <button class="plus-btn">+</button>
        </div>
        <div class="custom-habit-wrapper">
          <input type="text" class="custom-emoji-input" placeholder="Emoji">
          <input type="text" class="custom-habit-input" placeholder="H√°bito personalizado...">
          <button class="custom-habit-btn">Agregar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dejar -->
  <div class="accordion" data-category="Dejar">
    <div class="accordion-header">
      <h3>H√°bitos a Dejar</h3>
      <span>+</span>
    </div>
    <div class="accordion-content">
      <div class="habit-list">
        <div class="habit-item" data-category="Dejar" data-habit="Fumar">
          <div class="habit-label">
            <span class="habit-icon">üö≠</span>
            <span>Fumar</span>
          </div>
          <button class="plus-btn">+</button>
        </div>
        <div class="habit-item" data-category="Dejar" data-habit="Comida chatarra">
          <div class="habit-label">
            <span class="habit-icon">üçî</span>
            <span>Comida chatarra</span>
          </div>
          <button class="plus-btn">+</button>
        </div>
        <div class="habit-item" data-category="Dejar" data-habit="Bebidas azucaradas">
          <div class="habit-label">
            <span class="habit-icon">üßÉ</span>
            <span>Bebidas azucaradas</span>
          </div>
          <button class="plus-btn">+</button>
        </div>
        <div class="custom-habit-wrapper">
          <input type="text" class="custom-emoji-input" placeholder="Emoji">
          <input type="text" class="custom-habit-input" placeholder="H√°bito personalizado...">
          <button class="custom-habit-btn">Agregar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Objetivos -->
  <div id="objetivosContainer">
    <h2>Objetivos</h2>
    <div id="objetivosList"></div>
  </div>

  <!-- SIN bot√≥n "Enviar" manual. Telegram WebApp MainButton se usar√°. -->

  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>

  <script>
    // Simulamos la l√≥gica Angular + Telegram
    angular.module("custom-webapp-ui", [])
    .controller("CustomUIController", function($scope) {

      // Estructura base (similar a userInfo)
      $scope.userInfo = {
        name: "",
        age: "",
        // No guardaremos habits en un simple array de strings,
        // sino que iremos mapeando internamente. Pero necesitamos
        // "habitsList" para la visual en "H√°bitos registrados".
        habitsList: [],
        goals: [] // no forzamos a tener length exacto
      };

      // Prop para mostrar en #selectedHabitsList
      $scope.userInfo.habitsListStr = "";

      // Logica del acordeon / items seleccionados con MAX 5
      const MAX_HABITS = 5;
      let selectedCount = 0;

      // Mapa de objetivos y toggles
      // objectivesMap[habitKey] = { text: "", freq: "", category: "Salud", habitName: "Beber agua", toggled: false }
      const objectivesMap = {};

      // ACCORDEON
      document.querySelectorAll('.accordion').forEach(accordion => {
        const header = accordion.querySelector('.accordion-header');
        const content = accordion.querySelector('.accordion-content');
        header.addEventListener('click', () => {
          const isOpen = content.classList.contains('open');
          document.querySelectorAll('.accordion-content').forEach(ac => {
            ac.classList.remove('open');
            ac.style.maxHeight = null;
          });
          if(!isOpen) {
            content.classList.add('open');
            content.style.maxHeight = content.scrollHeight + 'px';
          }
        });
      });

      // Seleccionar/deseleccionar h√°bitos fijos
      document.querySelectorAll('.habit-item').forEach(item => {
        item.addEventListener('click', (e) => {
          e.stopPropagation();
          if(!item.classList.contains('selected')) {
            if(selectedCount < MAX_HABITS) {
              item.classList.add('selected');
              selectedCount++;
            } else {
              alert('M√°ximo de 5 h√°bitos alcanzado.');
              return;
            }
          } else {
            item.classList.remove('selected');
            selectedCount--;
            delete objectivesMap[getHabitKey(item)];
          }
          refreshUI();
        });
      });

      // A√±adir h√°bito personalizado con emoji
      document.querySelectorAll('.custom-habit-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const parent = btn.closest('.habit-list');
          const emojiInput = parent.querySelector('.custom-emoji-input');
          const habitInput = parent.querySelector('.custom-habit-input');
          const category = parent.closest('.accordion').dataset.category;
          const customEmoji = emojiInput.value.trim() || '‚≠ê';
          const customName = habitInput.value.trim();

          if(!customName) {
            alert('Ingresa un nombre para el h√°bito.');
            return;
          }
          if(selectedCount >= MAX_HABITS) {
            alert('M√°ximo de 5 h√°bitos alcanzado.');
            return;
          }

          // Crear un nuevo div .habit-item
          const newHabit = document.createElement('div');
          newHabit.className = 'habit-item selected';
          newHabit.dataset.category = category;
          newHabit.dataset.habit = customName;

          newHabit.innerHTML = `
            <div class="habit-label">
              <span class="habit-icon">${customEmoji}</span>
              <span>${customName}</span>
            </div>
            <button class="plus-btn">+</button>
          `;
          selectedCount++;

          emojiInput.value = '';
          habitInput.value = '';

          newHabit.addEventListener('click', (ev) => {
            ev.stopPropagation();
            if(newHabit.classList.contains('selected')) {
              newHabit.classList.remove('selected');
              selectedCount--;
              delete objectivesMap[getHabitKey(newHabit)];
            } else {
              if(selectedCount < MAX_HABITS) {
                newHabit.classList.add('selected');
                selectedCount++;
              } else {
                alert('M√°ximo de 5 h√°bitos alcanzado.');
              }
            }
            refreshUI();
          });

          parent.insertBefore(newHabit, parent.querySelector('.custom-habit-wrapper'));
          refreshUI();
        });
      });

      // REFRESH UI
      function refreshUI() {
        // Actualizamos la lista textual de h√°bitos
        const selected = document.querySelectorAll('.habit-item.selected');
        const listStr = [];
        const habList = [];
        selected.forEach(item => {
          const category = item.dataset.category;
          const habitName = item.dataset.habit;
          listStr.push(habitName);
          habList.push({category, habit: habitName});
        });
        $scope.userInfo.habitsList = habList;
        $scope.userInfo.habitsListStr = (listStr.length > 0)? listStr.join(', ') : '(vac√≠o)';

        // Actualizamos la parte de objetivos
        // Aseguramos que objectivesMap tenga freq = 'semanal' por defecto
        habList.forEach(h => {
          const key = h.category + '|' + h.habit;
          if(!objectivesMap[key]) {
            objectivesMap[key] = {
              category: h.category,
              habitName: h.habit,
              text: "",
              freq: "semanal",
              toggled: false
            };
          }
        });
        // Borramos del map lo que ya no est√© seleccionado
        Object.keys(objectivesMap).forEach(k => {
          const [cat, hab] = k.split('|');
          if(!habList.find(x => x.category===cat && x.habit===hab)) {
            delete objectivesMap[k];
          }
        });

        renderObjectives();
        $scope.updateMainButton();  // Angular function
        $scope.$applyAsync();
      }

      function getHabitKey(item) {
        return item.dataset.category + '|' + item.dataset.habit;
      }

      // Renderizar objetivos en #objetivosList
      function renderObjectives() {
        const container = document.getElementById('objetivosList');
        const selected = $scope.userInfo.habitsList;
        container.innerHTML = "";

        if(selected.length === 0) {
          document.getElementById('objetivosContainer').style.display = 'none';
          return;
        } else {
          document.getElementById('objetivosContainer').style.display = 'block';
        }

        selected.forEach(h => {
          const key = h.category + '|' + h.habit;
          const objData = objectivesMap[key];

          const row = document.createElement('div');
          row.className = 'objetivo-row';

          // Etiqueta
          const label = document.createElement('label');
          label.textContent = h.habit + ':';
          row.appendChild(label);

          if(!objData.toggled) {
            // Bot√≥n +
            const plusBtn = document.createElement('button');
            plusBtn.className = 'objetivo-plus-btn';
            plusBtn.textContent = '+';
            plusBtn.addEventListener('click', () => {
              objData.toggled = true;
              renderObjectives();
            });
            row.appendChild(plusBtn);
          } else {
            // Div con input y remove
            const contentDiv = document.createElement('div');
            contentDiv.className = 'objetivo-content';

            const inputObj = document.createElement('input');
            inputObj.type = 'text';
            inputObj.className = 'objetivo-input';
            inputObj.value = objData.text;
            inputObj.addEventListener('input', () => {
              objData.text = inputObj.value;
            });
            contentDiv.appendChild(inputObj);

            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-objetivo-btn';
            removeBtn.textContent = 'Quitar';
            removeBtn.addEventListener('click', () => {
              objData.toggled = false;
              objData.text = "";
              objData.freq = "semanal";
              renderObjectives();
            });
            contentDiv.appendChild(removeBtn);

            row.appendChild(contentDiv);

            // Frecuencia
            const freqDiv = document.createElement('div');
            freqDiv.className = 'frequency-row';
            const freqSelect = document.createElement('select');
            freqSelect.className = 'frequency-select';
            freqSelect.innerHTML = `
              <option value="diaria">Diaria</option>
              <option value="semanal">Semanal</option>
              <option value="mensual">Mensual</option>
            `;
            freqSelect.value = objData.freq;
            freqSelect.addEventListener('change', () => {
              objData.freq = freqSelect.value;
            });
            freqDiv.appendChild(freqSelect);

            row.appendChild(freqDiv);
          }

          container.appendChild(row);
        });
      }

      // L√ìGICA DE TELEGRAM MAIN BUTTON (similar a Angular snippet)
      const mainButton = window.Telegram.WebApp.MainButton;
      mainButton.text = "üö´ Completa todos los campos üö´";
      mainButton.color = "#ccc";
      mainButton.disable();
      mainButton.show();

      // Funci√≥n para chequear si el formulario "est√° listo"
      $scope.isFormComplete = function() {
        // En tu snippet original, ped√≠as que name, age no est√©n vac√≠os, haya >=1 habit
        // y metas estuvieran rellenas. Pero aqu√≠ adaptamos:
        return ($scope.userInfo.name.trim() && $scope.userInfo.age.trim() && $scope.userInfo.habitsList.length > 0);
      };

      // Al pulsar el mainButton, enviamos data a Telegram
      $scope.submit = function() {
        // Estructura final:
        // {
        //   Nombre: <string>,
        //   Edad: <string>,
        //   Habito: [(cat, hab), ...],
        //   Objetivos: [(cat, hab, objetivo, freq), ...]
        // }
        const Nombre = $scope.userInfo.name;
        const Edad = $scope.userInfo.age;

        // Habito
        const Habito = $scope.userInfo.habitsList.map(x => [x.category, x.habit]);

        // Objetivos: s√≥lo los que toggled = true y text != ""
        const Objetivos = [];
        Object.values(objectivesMap).forEach(obj => {
          if(obj.toggled && obj.text.trim()) {
            Objetivos.push([obj.category, obj.habitName, obj.text, obj.freq]);
          }
        });

        const finalDict = {
          Nombre,
          Edad,
          Habito,
          Objetivos
        };

        const data = JSON.stringify(finalDict);
        window.Telegram.WebApp.sendData(data);
      };

      // updateMainButton() => habilita o deshabilita el bot√≥n segun isFormComplete()
      $scope.updateMainButton = function() {
        if($scope.isFormComplete()) {
          mainButton.text = "üí™ Completar registro üí™";
          mainButton.color = "#419144";
          mainButton.enable();
          mainButton.onClick($scope.submit);
        } else {
          mainButton.text = "üö´ Completa todos los campos üö´";
          mainButton.color = "#ccc";
          mainButton.disable();
        }
      };

      // Al iniciar
      $scope.updateMainButton();
    });
  </script>
  <script>
    // Inicializa Telegram WebApp
    if(window.Telegram && window.Telegram.WebApp) {
      window.Telegram.WebApp.expand();
      // optional: window.Telegram.WebApp.enableClosingConfirmation();
    }
  </script>
</body>
</html>
